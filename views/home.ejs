<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Atendimento</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link rel="stylesheet" href="/style.css">
  <script>
    function mostrarChat(number, name) {
      document.querySelector(".chat-container").style.display = "block"; 
      document.getElementById("chat-number").textContent = `${name} (${number})`; 
      document.getElementById("chat-number-hidden").value = number; 
    }

    async function enviarPagamento(number) {
      const response = await fetch('/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number })
      });

      if (response.ok) {
        alert("OpÃ§Ãµes de pagamento enviadas!");
      } else {
        alert("Algo deu errado");
      }
    }

    async function encerrarAtendimento(number) {
      const response = await fetch('/end', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number })
      });

      if (response.ok) {
        alert("Atendimento encerrado!");
      } else {
        alert("Algo deu errado");
      }
    }

    async function atenderCliente(number, name) {
      const response = await fetch('/attend', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number, seller: 'Vend. A' })
      });
            
      if (response.ok) {
        carregarChat(number, name)
      } else {
        alert("Ja esta sendo atendido");
      }
    }

    async function carregarChat(number, name) {
      try {
        const response = await fetch(`/chat/${number}`);
        if (!response.ok) throw new Error("Erro ao carregar chat");

        const chatHtml = await response.text();
        document.getElementById("chat-container").innerHTML = chatHtml;
        mostrarChat(number, name)
      } catch (error) {
        alert(error.message);
      }
    }
  </script>
</head>
<body>

  <!-- Sidebar com a lista de clientes -->
  <div class="sidebar">
    <h2>ðŸ“‹ Fila de Espera</h2>
    <table>
      <tr>
        <th>Status</th>
        <th>Nome</th>
        <th>AÃ§Ãµes</th>
      </tr>
      <% queue.forEach(data => { %>
        <tr>
          <td>
            <% if (data.client.seller) { %>
              <span style="color: red; font-weight: bold;">ðŸ”´ Em Atendimento</span>
            <% } else { %>
              <span style="color: green; font-weight: bold;">ðŸŸ¢ DisponÃ­vel</span>
            <% } %>
          </td>
          <td><%= data.client.name %></td>
          <td>
            <button onclick="enviarPagamento('<%= data.client.number %>')">Enviar Pagamento</button>
            <button onclick="encerrarAtendimento('<%= data.client.number %>')">Encerrar Atendimento</button>
            <button onclick="atenderCliente('<%= data.client.number %>', '<%= data.client.name %>')">Atender</button>
          </td>
        </tr>
      <% }); %>
    </table>
  </div>

  <!-- Chat incluÃ­do -->
  <div id="chat-container" class="chat-container">
    <%- include('chat', { messages: [], number: '' }) %>
  </div>
</body>
</html>
